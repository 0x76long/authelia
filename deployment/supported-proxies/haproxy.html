<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>HAProxy - Authelia</title> <link rel="shortcut icon" href="https://docs.authelia.com/docs/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="https://docs.authelia.com/docs/assets/css/just-the-docs.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-124926127-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', "UA-124926127-1"); </script> <script type="text/javascript" src="https://docs.authelia.com/docs/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="https://docs.authelia.com/docs/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>HAProxy | Authelia</title> <meta name="generator" content="Jekyll v3.8.7" /> <meta property="og:title" content="HAProxy" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Authelia is an open source multi-factor single sign-on portal for web applications" /> <meta property="og:description" content="Authelia is an open source multi-factor single sign-on portal for web applications" /> <link rel="canonical" href="https://docs.authelia.com/docs/deployment/supported-proxies/haproxy.html" /> <meta property="og:url" content="https://docs.authelia.com/docs/deployment/supported-proxies/haproxy.html" /> <meta property="og:site_name" content="Authelia" /> <script type="application/ld+json"> {"@type":"WebPage","url":"https://docs.authelia.com/docs/deployment/supported-proxies/haproxy.html","headline":"HAProxy","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://docs.authelia.com/docs/images/authelia-title.png"}},"description":"Authelia is an open source multi-factor single sign-on portal for web applications","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" /> </head> <body> <a class="github-fork-ribbon" href="https://github.com/authelia/authelia" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"> </path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="https://docs.authelia.com/docs" class="site-title lh-tight"> <div class="site-logo"></div> </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item"><a href="https://docs.authelia.com/docs/" class="navigation-list-link">Home</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/home/architecture.html" class="navigation-list-link">Architecture</a></li></ul></li><li class="navigation-list-item"><a href="https://docs.authelia.com/docs/getting-started.html" class="navigation-list-link">Getting Started</a></li><li class="navigation-list-item"><a href="https://docs.authelia.com/docs/features/" class="navigation-list-link">Features</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/features/first-factor.html" class="navigation-list-link">First Factor</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/features/2fa/" class="navigation-list-link">Second Factor</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://docs.authelia.com/docs/features/2fa/one-time-password.html" class="navigation-list-link">One-Time Password</a> </li><li class="navigation-list-item "> <a href="https://docs.authelia.com/docs/features/2fa/security-key.html" class="navigation-list-link">Security Keys</a> </li><li class="navigation-list-item "> <a href="https://docs.authelia.com/docs/features/2fa/push-notifications.html" class="navigation-list-link">Push Notification</a> </li></ul></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/features/single-factor.html" class="navigation-list-link">Single Factor</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/features/password-reset.html" class="navigation-list-link">Password Reset</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/features/access-control.html" class="navigation-list-link">Access Control</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/features/regulation.html" class="navigation-list-link">Regulation</a></li></ul></li><li class="navigation-list-item"><a href="https://docs.authelia.com/docs/configuration/" class="navigation-list-link">Configuration</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/configuration/access-control.html" class="navigation-list-link">Access Control</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/configuration/authentication/" class="navigation-list-link">Authentication backends</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://docs.authelia.com/docs/configuration/authentication/file.html" class="navigation-list-link">File</a> </li><li class="navigation-list-item "> <a href="https://docs.authelia.com/docs/configuration/authentication/ldap.html" class="navigation-list-link">LDAP</a> </li></ul></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/configuration/duo-push-notifications.html" class="navigation-list-link">Duo Push Notifications</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/configuration/miscellaneous.html" class="navigation-list-link">Miscellaneous</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/configuration/one-time-password.html" class="navigation-list-link">One-Time Password</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/configuration/regulation.html" class="navigation-list-link">Regulation</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/configuration/notifier/" class="navigation-list-link">Notifier</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://docs.authelia.com/docs/configuration/notifier/filesystem.html" class="navigation-list-link">Filesystem</a> </li><li class="navigation-list-item "> <a href="https://docs.authelia.com/docs/configuration/notifier/smtp.html" class="navigation-list-link">SMTP</a> </li></ul></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/configuration/secrets.html" class="navigation-list-link">Secrets</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/configuration/server.html" class="navigation-list-link">Server</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/configuration/session.html" class="navigation-list-link">Session</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/configuration/storage/" class="navigation-list-link">Storage backends</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://docs.authelia.com/docs/configuration/storage/mariadb.html" class="navigation-list-link">MariaDB</a> </li><li class="navigation-list-item "> <a href="https://docs.authelia.com/docs/configuration/storage/mysql.html" class="navigation-list-link">MySQL</a> </li><li class="navigation-list-item "> <a href="https://docs.authelia.com/docs/configuration/storage/postgres.html" class="navigation-list-link">PostgreSQL</a> </li><li class="navigation-list-item "> <a href="https://docs.authelia.com/docs/configuration/storage/sqlite.html" class="navigation-list-link">SQLite</a> </li></ul></li></ul></li><li class="navigation-list-item active"><a href="https://docs.authelia.com/docs/deployment/" class="navigation-list-link">Deployment</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/deployment/deployment-lite.html" class="navigation-list-link">Deployment - Lite</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/deployment/deployment-ha.html" class="navigation-list-link">Deployment - Highly-Available</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/deployment/deployment-kubernetes.html" class="navigation-list-link">Deployment - Kubernetes</a></li><li class="navigation-list-item active"><a href="https://docs.authelia.com/docs/deployment/supported-proxies/" class="navigation-list-link">Proxy Integration</a><ul class="navigation-list-child-list"><li class="navigation-list-item active"> <a href="https://docs.authelia.com/docs/deployment/supported-proxies/haproxy.html" class="navigation-list-link active">HAProxy</a> </li><li class="navigation-list-item "> <a href="https://docs.authelia.com/docs/deployment/supported-proxies/nginx.html" class="navigation-list-link">Nginx</a> </li><li class="navigation-list-item "> <a href="https://docs.authelia.com/docs/deployment/supported-proxies/traefik1.x.html" class="navigation-list-link">Traefik 1.x</a> </li><li class="navigation-list-item "> <a href="https://docs.authelia.com/docs/deployment/supported-proxies/traefik2.x.html" class="navigation-list-link">Traefik 2.x</a> </li></ul></li></ul></li><li class="navigation-list-item"><a href="https://docs.authelia.com/docs/security/" class="navigation-list-link">Security</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/security/measures.html" class="navigation-list-link">Security Measures</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/security/threat-model.html" class="navigation-list-link">Threat Model</a></li></ul></li><li class="navigation-list-item"><a href="https://docs.authelia.com/docs/contributing/" class="navigation-list-link">Contributing</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/contributing/authelia-scripts.html" class="navigation-list-link">Authelia Scripts</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/contributing/build-and-dev.html" class="navigation-list-link">Build & Dev</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/contributing/suites.html" class="navigation-list-link">Suites</a></li></ul></li><li class="navigation-list-item"><a href="https://docs.authelia.com/docs/faq.html" class="navigation-list-link">FAQ</a></li><li class="navigation-list-item"><a href="https://docs.authelia.com/docs/roadmap.html" class="navigation-list-link">Roadmap</a></li><li class="navigation-list-item"><a href="https://docs.authelia.com/docs/community/" class="navigation-list-link">Community</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/community/two-factor-basic-auth.html" class="navigation-list-link">2FA through basic auth</a></li><li class="navigation-list-item "><a href="https://docs.authelia.com/docs/community/using-remote-user-header-for-sso-with-jira.html" class="navigation-list-link">Using Remote-User header for SSO with Jira</a></li></ul></li></ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search Authelia" aria-label="Search Authelia" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"> <title>Search</title> <g fill-rule="nonzero"> <path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z" /> <path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z" /> </g> </svg> </div> <div class="js-search-results search-results-wrap"></div> </div> </div> <div class="page"> <nav class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="https://docs.authelia.com/docs/deployment/">Deployment</a></li> <li class="breadcrumb-nav-list-item"><a href="https://docs.authelia.com/docs/deployment/supported-proxies/">Proxy Integration</a> </li> <li class="breadcrumb-nav-list-item"><span>HAProxy</span></li> </ol> </nav> <div id="main-content" class="page-content" role="main"> <h1 id="haproxy"> <a href="#haproxy" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> HAProxy </h1> <p><a href="https://www.haproxy.org/">HAProxy</a> is a reverse proxy supported by <strong>Authelia</strong>.</p> <h2 id="requirements"> <a href="#requirements" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Requirements </h2> <p>You need the following to run Authelia with HAProxy:</p> <ul> <li>HAProxy 1.8.4+ <ul> <li><code class="language-plaintext highlighter-rouge">USE_LUA=1</code> set at compile time</li> </ul> </li> <li><a href="https://github.com/TimWolla/haproxy-auth-request/blob/master/auth-request.lua">haproxy-auth-request</a></li> <li>LuaSocket with commit <a href="https://github.com/diegonehab/luasocket/commit/0b03eec16be0b3a5efe71bcb8887719d1ea87d60">0b03eec16b</a> (that is: newer than 2014-11-10) in your Lua library path (<code class="language-plaintext highlighter-rouge">LUA_PATH</code>) <ul> <li><code class="language-plaintext highlighter-rouge">lua-socket</code> from Debian Stretch works</li> <li><code class="language-plaintext highlighter-rouge">lua-socket</code> from Ubuntu Xenial works</li> <li><code class="language-plaintext highlighter-rouge">lua-socket</code> from Ubuntu Bionic works</li> <li><code class="language-plaintext highlighter-rouge">lua5.3-socket</code> from Alpine 3.8 works</li> <li><code class="language-plaintext highlighter-rouge">luasocket</code> from luarocks <em>does not</em> work</li> <li><code class="language-plaintext highlighter-rouge">lua-socket</code> v3.0.0.17.rc1 from EPEL <em>does not</em> work</li> <li><code class="language-plaintext highlighter-rouge">lua-socket</code> from Fedora 28 <em>does not</em> work</li> </ul> </li> </ul> <h2 id="configuration"> <a href="#configuration" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Configuration </h2> <p>Below you will find commented examples of the following configuration:</p> <ul> <li>Authelia portal</li> <li>Protected endpoint (Nextcloud)</li> <li><a href="https://github.com/TimWolla/haproxy-auth-request/blob/master/auth-request.lua">haproxy-auth-request</a></li> </ul> <p>With this configuration you can protect your virtual hosts with Authelia, by following the steps below:</p> <ol> <li>Add host(s) to the <code class="language-plaintext highlighter-rouge">protected-frontends</code> ACL to support protection with Authelia. You can separate each subdomain with a <code class="language-plaintext highlighter-rouge">|</code> in the regex, for example: <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> acl protected-frontends hdr(host) -m reg -i ^(jenkins|nextcloud|phpmyadmin)\.example\.com
</code></pre></div> </div> </li> <li>Add host ACL(s) in the form of <code class="language-plaintext highlighter-rouge">host-service</code>, this will be utilised to route to the correct backend upon successful authentication, for example: <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> acl host-jenkins hdr(host) -i jenkins.example.com
 acl host-nextcloud hdr(host) -i nextcloud.example.com
 acl host-phpmyadmin hdr(host) -i phpmyadmin.example.com
</code></pre></div> </div> </li> <li>Add backend route for your service(s), for example: <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> use_backend be_jenkins if host-jenkins
 use_backend be_nextcloud if host-nextcloud
 use_backend be_phpmyadmin if host-phpmyadmin
</code></pre></div> </div> </li> <li>Add backend definitions for your service(s), for example: <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> backend be_jenkins
     server jenkins jenkins:8080
 backend be_nextcloud
     server nextcloud nextcloud:443 ssl verify none
 backend be_phpmyadmin
     server phpmyadmin phpmyadmin:80
</code></pre></div> </div> </li> </ol> <h3 id="secure-authelia-with-tls"> <a href="#secure-authelia-with-tls" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Secure Authelia with TLS </h3> <p>There is a <a href="https://github.com/TimWolla/haproxy-auth-request/issues/12">known limitation</a> with haproxy-auth-request with regard to TLS-enabled backends. If you want to run Authelia TLS enabled the recommended workaround utilises HAProxy itself to proxy the requests. This comes at a cost of two additional TCP connections, but allows the full HAProxy configuration flexbility with regard to TLS verification as well as header rewriting. An example of this configuration is also be provided below.</p> <h4 id="configuration-1"> <a href="#configuration-1" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Configuration </h4> <h5 id="haproxycfg"> <a href="#haproxycfg" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> haproxy.cfg </h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>global
    # Path to haproxy-auth-request
    lua-load /usr/local/etc/haproxy/auth-request.lua
    log stdout format raw local0 debug

defaults
    mode http
    log global
    option httplog
    option forwardfor

frontend fe_http
    bind *:443 ssl crt /usr/local/etc/haproxy/haproxy.pem
    
    # Host ACLs
    acl protected-frontends hdr(host) -m reg -i ^(nextcloud)\.example\.com
    acl host-authelia hdr(host) -i auth.example.com
    acl host-nextcloud hdr(host) -i nextcloud.example.com

    http-request set-var(req.scheme) str(https) if { ssl_fc }
    http-request set-var(req.scheme) str(http) if !{ ssl_fc }
    http-request set-var(req.questionmark) str(?) if { query -m found }
   
    # Headers to construct redirection URL
    http-request set-header X-Real-IP %[src]
    http-request set-header X-Forwarded-Proto %[var(req.scheme)]
    http-request set-header X-Forwarded-Host %[req.hdr(Host)]
    http-request add-header X-Forwarded-Port %[dst_port]
    http-request set-header X-Forwarded-Uri %[path]%[var(req.questionmark)]%[query]

    # Protect endpoints with haproxy-auth-request and Authelia
    http-request lua.auth-request be_authelia /api/verify if protected-frontends
   
    # Authelia backend route
    use_backend be_authelia if host-authelia
    # Redirect protected-frontends to Authelia if not authenticated
    use_backend be_authelia if protected-frontends !{ var(txn.auth_response_successful) -m bool }
    # Service backend route(s)
    use_backend be_nextcloud if host-nextcloud

backend be_authelia
    server authelia authelia:9091

backend be_nextcloud
    server nextcloud nextcloud:443 ssl verify none
</code></pre></div></div> <h5 id="haproxycfg-tls-enabled-authelia"> <a href="#haproxycfg-tls-enabled-authelia" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> haproxy.cfg (TLS enabled Authelia) </h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>global
    # Path to haproxy-auth-request
    lua-load /usr/local/etc/haproxy/auth-request.lua
    log stdout format raw local0 debug

defaults
    mode http
    log global
    option httplog
    option forwardfor

frontend fe_http
    bind *:443 ssl crt /usr/local/etc/haproxy/haproxy.pem
    
    # Host ACLs
    acl protected-frontends hdr(host) -m reg -i ^(nextcloud)\.example\.com
    acl host-authelia hdr(host) -i auth.example.com
    acl host-nextcloud hdr(host) -i nextcloud.example.com

    http-request set-var(req.scheme) str(https) if { ssl_fc }
    http-request set-var(req.scheme) str(http) if !{ ssl_fc }
    http-request set-var(req.questionmark) str(?) if { query -m found }
   
    # Headers to construct redirection URL
    http-request set-header X-Real-IP %[src]
    http-request set-header X-Forwarded-Proto %[var(req.scheme)]
    http-request set-header X-Forwarded-Host %[req.hdr(Host)]
    http-request add-header X-Forwarded-Port %[dst_port]
    http-request set-header X-Forwarded-Uri %[path]%[var(req.questionmark)]%[query]

    # Protect endpoints with haproxy-auth-request and Authelia
    http-request lua.auth-request be_authelia_proxy /api/verify if protected-frontends
   
    # Authelia backend route
    use_backend be_authelia if host-authelia
    # Redirect protected-frontends to Authelia if not authenticated
    use_backend be_authelia if protected-frontends !{ var(txn.auth_response_successful) -m bool }
    # Service backend route(s)
    use_backend be_nextcloud if host-nextcloud

backend be_authelia
    server authelia authelia:9091

backend be_authelia_proxy
    mode http
    server proxy 127.0.0.1:9092

listen authelia_proxy
    mode http
    bind 127.0.0.1:9092
    server authelia authelia:9091 ssl verify none

backend be_nextcloud
    server nextcloud nextcloud:443 ssl verify none
</code></pre></div></div> <hr> <footer role="contentinfo"> <p class="text-small text-grey-dk-000 mb-0">Copyright &copy; 2020 Authelia. Distributed by an <a href="https://github.com/authelia/authelia/blob/master/LICENSE">Apache 2.0 license.</a></p> </footer> </div> </div> </div> </div> </body> </html>
